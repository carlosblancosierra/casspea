{% extends "base.html" %}

{% load static %}

{% block head_title %}{{ block.super }} Box Flavours{% endblock %}

{% block content %}

{% url 'store:add_boxes' as add_boxes_url %}

{% include "base/inner-banner.html" %}


<div class="container">
  <div class="row">
    <div class="row mt-5">

      <div class="col s12 m6 ">
        {% if box_obj.image %}
        <img src="{{ box_obj.image.url }}" class="responsive-img">
        {% endif %}

        <div class="row">
          {% if box_obj.image2 %}
          <div class="col s6">
            <img src="{{ box_obj.image2.url }}" class="responsive-img">
          </div>
          {% endif %}

          {% if box_obj.image3 %}
          <div class="col s6">
            <img src="{{ box_obj.image3.url }}" class="responsive-img">
          </div>
          {% endif %}

          {% if box_obj.image4 %}
          <div class="col s6">
            <img src="{{ box_obj.image4.url }}" class="responsive-img">
          </div>
          {% endif %}

          {% if box_obj.image5 %}
          <div class="col s6">
            <img src="{{ box_obj.image5.url }}" class="responsive-img">
          </div>
          {% endif %}
        </div>

      </div>

      <div class="col s12 m6">
        <h1 class="font-250">{{ size }} Pieces Box</h1>
        {% if box_obj.description %}
        <p>{{ box_obj.description }}</p>
        {% endif %}
        <form method="POST" action="{{ add_boxes_url }}"> {% csrf_token %}
          <p class="bold">Quantity</p>
          <div class="row">
            <!--            <label for="box_quantity">How many boxes of {{ quantity }} pieces?</label>-->

            <div class="col s12">
              <button class="btn btn-green btn-number"
                      data-type="minus" data-field="box_quantity"
              >-
              </button>

              <input id="box_quantity" type="number"
                     name="box_quantity" class="validate center browser-default"
                     required min="0" value="1" max="100">

              <button class="btn btn-green btn-number"
                      data-type="plus" data-field="box_quantity"
              >+
              </button>
            </div>


          </div>

          <div class="row">
            <div class="col s12">
              <p class="bold">Pick your flavour</p>
            </div>
            <div class="col s6">
              <p>
                <label onclick="showPreBuiltCol()" class="btn boxes-radio-green-btn">
                  <input name="{{ FLAVOUR_FORMAT }}" type="radio" value="{{ PRE_BUILT }}"
                         required/>
                  <span>Pre Built</span>
                </label>
              </p>
            </div>
            <div class="col s6">
              <p>
                <label onclick="showPickAndMixCol()" class="btn boxes-radio-green-btn">
                  <input name="{{ FLAVOUR_FORMAT }}" type="radio" value="{{ PICK_AND_MIX }}" required/>
                  <span>Pick and Mix</span>
                </label>
              </p>
            </div>

          </div>


          <div class="row">
            <div class="col s12" id="preBuiltCol">
              {% for obj in prebuilds %}
              <p class="box-flavour-radio">
                <label>
                  <input class="" name="{{ obj.slug }}" type="checkbox"/>
                  <span>{{ obj.name }}</span>
                </label>
              </p>
              {% endfor %}


            </div>
            <div class="col s12" id="pickAndMixCol">
             <p><span id="remaining-flavours">{{ size }}</span> Chocolates remaining</p>
              {% for flavour in flavours %}
              <div class="row box-flavour-radio">
                <div class="col s12 m7">
                  <p class="mt-0">{{ flavour.name }}</p>
                </div>
                <div class="col s12 m5">
                  <button class="btn btn-green btn-number"
                          data-type="minus" data-field="{{ flavour.slug }}"
                  >-</button>

                  <input id="{{ flavour.slug }}" type="number" 
        
                         name="{{ flavour.slug }}" class="flavour-input validate center browser-default"
                         required min="0" value="0" max="1000">

                  <button class="btn btn-green btn-number flavour-plus-btn"
                          data-type="plus" data-field="{{ flavour.slug }}"
                  >+</button>
                </div>
              </div>

              <!--              <div class="row">-->
              <!--                <div class="input-field col s10">-->
              <!--                  <input id="{{ flavour.slug }}" type="number" name="{{ flavour.alug }}">-->
              <!--                  <label for="{{ flavour.slug }}">{{ flavour.name }}</label>-->
              <!--                </div>-->
              <!--              </div>-->
              {% endfor %}

            </div>
          </div>

          <input type="hidden" value="{{ size }}" name="size">
          <p class="center">
            <button type="submit" class="btn-large btn-orange">Add Boxes to Cart</button>
          </p>

        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block js_extra %}

<script>
  const preBuiltCol = document.getElementById('preBuiltCol')
  const pickAndMixCol = document.getElementById('pickAndMixCol')
  preBuiltCol.style.display = 'none';
  pickAndMixCol.style.display = 'none';

  function showPreBuiltCol() {
      pickAndMixCol.style.display = 'none';
      preBuiltCol.style.display = 'block';
  }

  function showPickAndMixCol() {
    preBuiltCol.style.display = 'none';
    pickAndMixCol.style.display = 'block';
  }

const max = parseInt({{ size }})
const flavourInputs = $('.flavour-input');
const flavourPlusBtns = $('.flavour-plus-btn');
const flavoursRemaining = $('#remaining-flavours');
var remaining = max

function sumInputs() {
  var sum = 0;
  for (let i = 0; i < flavourInputs.length; i++) {
    sum += parseInt(flavourInputs[i].value);
  }
  return sum
}

flavourInputs.change(function() {
  sum = sumInputs()

  if (sum === max) {
    flavourPlusBtns.prop("disabled",true);
  } else {
    flavourPlusBtns.prop("disabled",false);
  }
  remaining = max - sum;
  flavoursRemaining.text(remaining);
});

flavourInputs.keypress(function (evt) {
    evt.preventDefault();
});


$('.btn-number').click(function(e){
    e.preventDefault();

    fieldName = $(this).attr('data-field');
    type      = $(this).attr('data-type');
    var input = $("input[name='"+fieldName+"']");
    var currentVal = parseInt(input.val());
    if (!isNaN(currentVal)) {
        if(type == 'minus') {
            if(currentVal > input.attr('min')) {
                input.val(currentVal - 1).change();
            }

        } else if(type == 'plus') {

            if(currentVal < input.attr('max')) {
                input.val(currentVal + 1).change();
            }
        }
    } else {
        input.val(0);
    }
});


$('.input-number').focusin(function(){
   $(this).data('oldValue', $(this).val());
});
$('.input-number').change(function() {

    minValue =  parseInt($(this).attr('min'));
    maxValue =  parseInt($(this).attr('max'));
    valueCurrent = parseInt($(this).val());

    name = $(this).attr('name');
    if(valueCurrent >= minValue) {
        $(".btn-number[data-type='minus'][data-field='"+name+"']").removeAttr('disabled')
    } else {
        alert('Sorry, the minimum value was reached');
        $(this).val($(this).data('oldValue'));
    }
    if(valueCurrent <= maxValue) {
        $(".btn-number[data-type='plus'][data-field='"+name+"']").removeAttr('disabled')
    } else {
        alert('Sorry, the maximum value was reached');
        $(this).val($(this).data('oldValue'));
    }


});

</script>

{% endblock %}